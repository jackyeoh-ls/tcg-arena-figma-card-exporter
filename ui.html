<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; color: #333; }
    
    /* HEADER */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 15px;
    }
    h3 { margin: 0; font-size: 14px; font-weight: 700; }

    /* TABS */
    .tabs { display: flex; gap: 4px; }
    .tab { 
      padding: 4px 8px; cursor: pointer; color: #666; font-size: 10px;
      border-radius: 4px; background: #f5f5f5; border: 1px solid transparent; transition: all 0.2s;
    }
    .tab:hover:not(.active) { background: #eee; color: #333; }
    .tab.active { color: #18A0FB; background: #e3f2fd; border-color: #18A0FB; font-weight: bold; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* LAYOUT */
    .row { display: flex; gap: 15px; margin-bottom: 15px; }
    .col { flex: 1; }
    .settings-container { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 15px; }
    
    /* INPUTS */
    label { font-weight: bold; font-size: 11px; cursor: pointer; display: block; margin-bottom: 4px; }
    select, button, input[type="text"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 11px; }
    
    .input-line { display: flex; align-items: center; height: 30px; }
    .checkbox-group { display: flex; align-items: center; height: 30px; }
    
    .input-inline {
      width: 40px; padding: 4px; text-align: center; border-radius: 4px; border: 1px solid #ccc;
      margin-left: 8px; font-size: 11px; height: 26px; box-sizing: border-box;
    }
    
    .helper-text { font-size: 10px; color: #999; margin-top: 2px; line-height: 1.2; }
    .checkbox-label { display: flex; align-items: center; font-weight: normal; margin: 0; white-space: nowrap; font-size: 11px; }
    input[type="checkbox"] { width: auto; margin: 0 6px 0 0; }

    /* BUTTONS */
    .btn-primary { background: #18A0FB; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary:hover { background: #0D8ADB; }
    .btn-secondary { background: white; color: #333; cursor: pointer; font-weight: normal; border: 1px solid #ccc; }
    .btn-secondary:hover { background: #f0f0f0; }
    .btn-success { background: #22c55e; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-success:hover { background: #16a34a; }
    .btn-neutral { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; cursor: pointer; font-weight: bold; }
    .btn-neutral:hover { background: #e5e7eb; }
    
    button:disabled, select:disabled, input:disabled { background: #eee !important; color: #aaa !important; cursor: not-allowed; border-color: #ddd; }

    /* TEXTAREA */
    textarea { width: 100%; height: 175px; font-family: monospace; font-size: 10px; margin-top: 5px; border: 1px solid #ddd; }
    
    /* STATUS */
    .status { margin-top: 10px; font-size: 11px; font-weight: bold; }
    .status.error { color: red; }
    .status.success { color: green; }
    .meta-info { font-size: 10px; color: #666; margin-top: 15px; background: #f5f5f5; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="header">
    <h3>TCG Card Exporter</h3>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('tab-export')">JSON Exporter</div>
      <div class="tab" onclick="switchTab('tab-extract')">Frame Extractor</div>
      <div class="tab" onclick="switchTab('tab-minideck')">Minideck Data</div>
    </div>
  </div>

  <div id="tab-export" class="tab-content active">
    <div style="margin-bottom: 15px;">
      <label for="pageSelect">Select Page to Scan</label>
      <select id="pageSelect"></select>
    </div>

    <div class="settings-container">
      <div class="depth-group">
        <div class="input-line">
          <label for="scanDepth">Scan Depth</label>
          <input type="number" id="scanDepth" class="input-inline" value="3" min="1" max="10">
        </div>
        <div class="helper-text" style="margin-left:6px;">increase this if cards<br>are nested too deeply</div>
      </div>
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="chkExportImages" checked>
          Export Images (PNG)
        </label>
      </div>
    </div>

    <div class="row">
      <button id="runBtn" class="btn-primary col">Smart Scan</button>
      <button id="forceBtn" class="btn-secondary col">Force Full Scan</button>
    </div>

    <div id="status" class="status">Ready.</div>
    
    <div id="lastScanInfo" class="meta-info hidden">
      <strong>Last Scan:</strong> <span id="lastScanTime">Never</span> | <span id="lastScanCount">0</span> items.
    </div>

    <div id="resultArea" class="hidden">
      <label style="margin-top:10px;">JSON Output</label>
      <textarea id="output" readonly></textarea>
      <div class="row" style="margin-top: 10px;">
        <button id="downloadBtn" class="btn-success col">Download ZIP</button>
        <button id="copyBtn" class="btn-neutral col">Copy JSON</button>
      </div>
    </div>
  </div>

  <div id="tab-extract" class="tab-content">
    <p class="helper-text" style="font-size:11px; margin-bottom:15px; color:#555;">
      Scans the Source Page for cards, renames pending cards, and copies frames to the Target Page.
    </p>

    <div style="margin-bottom: 15px;">
      <label for="sourcePageSelect">Source Page (Scan Here)</label>
      <select id="sourcePageSelect"></select>
    </div>

    <div style="margin-bottom: 20px;">
      <label for="targetPageSelect">Target Page (Copy To)</label>
      <select id="targetPageSelect"></select>
      <div class="helper-text" style="color:#d9534f; margin-top:5px; font-weight:bold;">Warning: Target Page content will be cleared!</div>
    </div>

    <button id="extractBtn" class="btn-primary">Extract Frames</button>
    <div id="extractStatus" class="status">Ready.</div>
  </div>

  <div id="tab-minideck" class="tab-content">
    <p class="helper-text" style="font-size:11px; margin-bottom:15px; color:#555;">
      Extracts Minideck JSON structure based on Frames (Deck Name -> Rarity -> Cards).
    </p>

    <div style="margin-bottom: 20px;">
      <label for="mdPageSelect">Select Page to Scan</label>
      <select id="mdPageSelect"></select>
    </div>

    <button id="mdExtractBtn" class="btn-primary">Extract Minideck Data</button>
    <div id="mdStatus" class="status">Ready.</div>

    <div id="mdResultArea" class="hidden">
      <label style="margin-top:10px;">JSON Output</label>
      <textarea id="mdOutput" readonly></textarea>
      <div class="row" style="margin-top: 10px;">
        <button id="mdCopyBtn" class="btn-neutral col">Copy JSON</button>
      </div>
    </div>
  </div>

  <script>
    // --- Elements: Tab 1 ---
    const pageSelect = document.getElementById('pageSelect');
    const scanDepthInput = document.getElementById('scanDepth');
    const chkExportImages = document.getElementById('chkExportImages');
    const runBtn = document.getElementById('runBtn');
    const forceBtn = document.getElementById('forceBtn');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    const resultArea = document.getElementById('resultArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const lastScanInfo = document.getElementById('lastScanInfo');
    const lastScanTime = document.getElementById('lastScanTime');
    const lastScanCount = document.getElementById('lastScanCount');

    // --- Elements: Tab 2 ---
    const sourcePageSelect = document.getElementById('sourcePageSelect');
    const targetPageSelect = document.getElementById('targetPageSelect');
    const extractBtn = document.getElementById('extractBtn');
    const extractStatus = document.getElementById('extractStatus');

    // --- Elements: Tab 3 ---
    const mdPageSelect = document.getElementById('mdPageSelect');
    const mdExtractBtn = document.getElementById('mdExtractBtn');
    const mdStatus = document.getElementById('mdStatus');
    const mdOutput = document.getElementById('mdOutput');
    const mdResultArea = document.getElementById('mdResultArea');
    const mdCopyBtn = document.getElementById('mdCopyBtn');

    let zipBlob = null;
    let accumulatedImages = [];

    // --- TABS ---
    window.switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      const activeTabBtn = document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`);
      if(activeTabBtn) activeTabBtn.classList.add('active');
    };

    // --- UI HELPERS ---
    function toggleInputs(disabled) {
      const allInputs = document.querySelectorAll('button, select, input, .tab');
      allInputs.forEach(el => {
        if(el.classList.contains('tab')) {
           el.style.pointerEvents = disabled ? 'none' : 'auto';
           el.style.opacity = disabled ? '0.5' : '1';
        } else {
           el.disabled = disabled;
        }
      });
    }

    function copyToClipboard(textAreaId, btnId) {
      const ta = document.getElementById(textAreaId);
      const btn = document.getElementById(btnId);
      ta.select();
      document.execCommand('copy');
      const originalText = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(() => btn.textContent = originalText, 1500);
    }

    // --- BUTTON LISTENERS ---
    runBtn.onclick = () => startScan(false);
    forceBtn.onclick = () => startScan(true);
    copyBtn.onclick = () => copyToClipboard('output', 'copyBtn');
    mdCopyBtn.onclick = () => copyToClipboard('mdOutput', 'mdCopyBtn');

    // EXPORT
    function startScan(forceFull) {
      const pageId = pageSelect.value;
      const doImages = chkExportImages.checked;
      const depth = parseInt(scanDepthInput.value, 10) || 3;
      if (!pageId) return;

      accumulatedImages = [];
      zipBlob = null;
      toggleInputs(true);
      
      const modeText = forceFull ? "Full Scan" : "Smart Scan";
      status.textContent = `Running ${modeText}...`;
      status.className = "status";
      resultArea.classList.add('hidden');
      lastScanInfo.classList.add('hidden'); 

      parent.postMessage({ pluginMessage: { 
        type: 'run-scan', pageId, exportImages: doImages, forceFull, scanDepth: depth 
      }}, '*');
    }

    // EXTRACT
    extractBtn.onclick = () => {
      const sourceId = sourcePageSelect.value;
      const targetId = targetPageSelect.value;
      if (!sourceId || !targetId) return;
      if (sourceId === targetId) { alert("Source and Target pages must be different."); return; }

      toggleInputs(true);
      extractStatus.textContent = "Extracting frames...";
      extractStatus.className = "status";

      parent.postMessage({ pluginMessage: { type: 'run-extract', sourceId, targetId }}, '*');
    };

    // MINIDECK EXTRACT
    mdExtractBtn.onclick = () => {
      const pageId = mdPageSelect.value;
      if (!pageId) return;

      toggleInputs(true);
      mdStatus.textContent = "Extracting Minideck Data...";
      mdStatus.className = "status";
      mdResultArea.classList.add('hidden');

      parent.postMessage({ pluginMessage: { type: 'extract-minideck-data', pageId }}, '*');
    };

    downloadBtn.onclick = () => {
      if (zipBlob) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `cards_export_${dateStr}_${timeStr}.zip`;
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = filename;
        link.click();
      }
    };

    // --- MESSAGE HANDLER ---
    window.onmessage = async (event) => {
      if (!event.data || !event.data.pluginMessage) return;
      const msg = event.data.pluginMessage;

      if (msg.type === 'init-state') {
        const fillSelect = (sel) => {
          sel.innerHTML = "";
          msg.pages.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            if (p.current) opt.selected = true;
            sel.appendChild(opt);
          });
        };
        fillSelect(pageSelect);
        fillSelect(sourcePageSelect);
        fillSelect(targetPageSelect);
        fillSelect(mdPageSelect);

        if (msg.lastScanDate) {
          lastScanInfo.classList.remove('hidden');
          lastScanTime.textContent = new Date(msg.lastScanDate).toLocaleString();
          lastScanCount.textContent = msg.lastScanCount || 0;
          if (msg.lastJson) {
            output.value = msg.lastJson;
            resultArea.classList.remove('hidden');
          }
        }
        status.textContent = "Ready.";
        toggleInputs(false);
      }

      else if (msg.type === 'image-chunk') {
        if (msg.data) accumulatedImages.push({ filename: msg.filename, data: msg.data });
        status.textContent = `Processing... (${msg.current} / ${msg.total})`;
      }

      else if (msg.type === 'complete') {
        status.textContent = `Generating ZIP...`;
        output.value = msg.json;
        resultArea.classList.remove('hidden');
        lastScanInfo.classList.remove('hidden');
        lastScanTime.textContent = "Just now";
        lastScanCount.textContent = msg.count;
        try {
          const zip = new JSZip();
          zip.file("cards.json", msg.json);
          if (accumulatedImages.length > 0) {
            const imgFolder = zip.folder("img");
            accumulatedImages.forEach(img => imgFolder.file(img.filename, img.data));
          }
          zipBlob = await zip.generateAsync({ type: "blob" });
          downloadBtn.textContent = `Download ZIP (${(zipBlob.size / 1024 / 1024).toFixed(2)} MB)`;
          status.textContent = `Done! Processed ${msg.count} items.`;
          status.className = "status success";
        } catch (err) {
          status.textContent = "ZIP Error: " + err.message;
          status.className = "status error";
        }
        toggleInputs(false);
      }

      else if (msg.type === 'extract-complete') {
        extractStatus.textContent = `Success! Copied ${msg.count} frames to "${msg.targetName}".`;
        extractStatus.className = "status success";
        toggleInputs(false);
      }

      else if (msg.type === 'minideck-data-complete') {
        mdStatus.textContent = `Success! Extracted data for ${msg.count} minidecks.`;
        mdStatus.className = "status success";
        mdOutput.value = msg.json;
        mdResultArea.classList.remove('hidden');
        toggleInputs(false);
      }

      else if (msg.type === 'error') {
        toggleInputs(false);
        const activeStatus = document.querySelector('.tab-content.active .status');
        if (activeStatus) {
            activeStatus.textContent = "Error: " + msg.message;
            activeStatus.className = "status error";
        } else {
            alert("Error: " + msg.message);
        }
      }
    };
  </script>
</body>
</html>