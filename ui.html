<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; color: #333; }
    
    /* Layout Helpers */
    .row { display: flex; gap: 15px; margin-bottom: 15px; }
    .col { flex: 1; }
    
    /* SETTINGS CONTAINER
       - Align items to start so the top row lines up perfectly.
       - Use gap to separate the Depth group from the Checkbox.
    */
    .settings-container {
      display: flex;
      align-items: flex-start; 
      gap: 20px; 
      margin-bottom: 15px;
    }

    /* LEFT SIDE: Depth Control + Helper */
    .depth-group {
      display: flex;
      flex-direction: column;
    }

    /* RIGHT SIDE: Checkbox */
    .checkbox-group {
      display: flex;
      align-items: center;
      /* IMPORANT: Match the height of the input-line (30px) 
         so the text/box centers align with the input box on the left */
      height: 30px; 
    }

    /* The row containing "Scan Depth" label and Input */
    .input-line {
      display: flex;
      align-items: center;
      height: 30px; /* Fixed height for alignment */
    }

    /* Inputs & Labels */
    label { font-weight: bold; font-size: 12px; cursor: pointer; user-select: none; }
    
    select, button, input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    
    .input-inline {
      width: 40px; 
      padding: 4px;
      text-align: center;
      border-radius: 4px; 
      border: 1px solid #ccc;
      margin-left: 8px;
      font-size: 12px;
      height: 28px; /* Fit inside the 30px line */
      box-sizing: border-box;
    }

    /* Helper Text */
    .helper-text {
      font-size: 10px;
      color: #999;
      margin-top: 2px;
      line-height: 1.2;
      margin-left: 0; /* Align with left edge of group */
    }

    /* Checkbox Specifics */
    .checkbox-label {
      display: flex; 
      align-items: center; 
      font-weight: normal; 
      margin: 0;
      white-space: nowrap; 
    }
    input[type="checkbox"] { width: auto; margin: 0 6px 0 0; }

    /* Buttons */
    .btn-primary { background: #18A0FB; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary:hover { background: #0D8ADB; }
    .btn-secondary { background: white; color: #333; cursor: pointer; font-weight: normal; border: 1px solid #ccc; }
    .btn-secondary:hover { background: #f0f0f0; }
    .btn-success { background: #22c55e; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-success:hover { background: #16a34a; }
    .btn-neutral { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; cursor: pointer; font-weight: bold; }
    .btn-neutral:hover { background: #e5e7eb; }
    
    button:disabled { background: #ccc !important; color: #666 !important; cursor: not-allowed; border: none; }

    textarea { width: 100%; height: 175px; font-family: monospace; font-size: 11px; margin-top: 5px; border: 1px solid #ddd; }
    
    .status { margin-top: 10px; font-size: 12px; font-weight: bold; }
    .status.error { color: red; }
    .status.success { color: green; }
    
    .meta-info { font-size: 11px; color: #666; margin-top: 15px; margin-bottom: 5px; background: #f5f5f5; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h3>TCG Arena Card Exporter</h3>

  <div style="margin-bottom: 15px;">
    <label for="pageSelect" style="display:block; margin-bottom:5px;">Select Page to Scan</label>
    <select id="pageSelect"></select>
  </div>

  <div class="settings-container">
    
    <div class="depth-group">
      <div class="input-line">
        <label for="scanDepth">Scan Depth</label>
        <input type="number" id="scanDepth" class="input-inline" value="3" min="1" max="10">
      <div class="helper-text" style="margin-left: 4px">
        increase this if cards<br>are nested too deeply
      </div>
      </div>

    </div>

    <div class="checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" id="chkExportImages" checked>
        Export Images (PNG)
      </label>
    </div>

  </div>

  <div class="row">
    <button id="runBtn" class="btn-primary col">Smart Scan</button>
    <button id="forceBtn" class="btn-secondary col">Force Full Scan</button>
  </div>

  <div id="status" class="status">Initializing...</div>
  
  <div id="lastScanInfo" class="meta-info hidden">
    <strong>Last Scan:</strong> <span id="lastScanTime">Never</span> | 
    <span id="lastScanCount">0</span> items.
  </div>

  <div id="resultArea" class="hidden">
    <label style="display:block; margin-bottom:5px;">JSON Output</label>
    <textarea id="output" readonly></textarea>
    
    <div class="row" style="margin-top: 10px;">
      <button id="downloadBtn" class="btn-success col">Download ZIP</button>
      <button id="copyBtn" class="btn-neutral col">Copy JSON</button>
    </div>
  </div>

  <script>
    const runBtn = document.getElementById('runBtn');
    const forceBtn = document.getElementById('forceBtn');
    const pageSelect = document.getElementById('pageSelect');
    const scanDepthInput = document.getElementById('scanDepth');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    const resultArea = document.getElementById('resultArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const lastScanInfo = document.getElementById('lastScanInfo');
    const lastScanTime = document.getElementById('lastScanTime');
    const lastScanCount = document.getElementById('lastScanCount');

    let zipBlob = null;
    let accumulatedImages = [];

    function startScan(forceFull) {
      const pageId = pageSelect.value;
      const doImages = document.getElementById('chkExportImages').checked;
      const depth = parseInt(scanDepthInput.value, 10) || 3;
      
      if (!pageId) return;

      accumulatedImages = [];
      zipBlob = null;
      
      runBtn.disabled = true;
      forceBtn.disabled = true;
      
      const modeText = forceFull ? "Full Scan" : "Smart Scan";
      status.textContent = `Running ${modeText}...`;
      status.className = "status";
      resultArea.classList.add('hidden');
      lastScanInfo.classList.add('hidden'); 

      parent.postMessage({ pluginMessage: { 
        type: 'run-scan', 
        pageId: pageId,
        exportImages: doImages,
        forceFull: forceFull,
        scanDepth: depth 
      }}, '*');
    }

    runBtn.onclick = () => startScan(false);
    forceBtn.onclick = () => startScan(true);

    copyBtn.onclick = () => {
      output.select();
      document.execCommand('copy'); 
      const originalText = copyBtn.textContent;
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = originalText, 1500);
    };

    downloadBtn.onclick = () => {
      if (zipBlob) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `cards_export_${dateStr}_${timeStr}.zip`;

        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = filename;
        link.click();
      }
    };

    window.onmessage = async (event) => {
      if (!event.data || !event.data.pluginMessage) return;
      const msg = event.data.pluginMessage;

      if (msg.type === 'init-state') {
        pageSelect.innerHTML = "";
        msg.pages.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          if (p.current) opt.selected = true;
          pageSelect.appendChild(opt);
        });

        if (msg.lastScanDate) {
          lastScanInfo.classList.remove('hidden');
          lastScanTime.textContent = new Date(msg.lastScanDate).toLocaleString();
          lastScanCount.textContent = msg.lastScanCount || 0;
          if (msg.lastJson) {
            output.value = msg.lastJson;
            resultArea.classList.remove('hidden');
          }
        }
        status.textContent = "Ready.";
        runBtn.disabled = false;
        forceBtn.disabled = false;
      }

      else if (msg.type === 'image-chunk') {
        if (msg.data) {
          accumulatedImages.push({ filename: msg.filename, data: msg.data });
        }
        status.textContent = `Processing... (${msg.current} / ${msg.total})`;
      }

      else if (msg.type === 'complete') {
        status.textContent = `Generating ZIP...`;
        output.value = msg.json;
        resultArea.classList.remove('hidden');

        lastScanInfo.classList.remove('hidden');
        lastScanTime.textContent = "Just now";
        lastScanCount.textContent = msg.count;

        try {
          const zip = new JSZip();
          zip.file("cards.json", msg.json);

          if (accumulatedImages.length > 0) {
            const imgFolder = zip.folder("img");
            accumulatedImages.forEach(img => {
              imgFolder.file(img.filename, img.data);
            });
            status.textContent = `Done! Updated ${accumulatedImages.length} images.`;
          } else {
            status.textContent = `Done! No images changed (JSON updated).`;
          }
          
          status.className = "status success";

          zipBlob = await zip.generateAsync({ type: "blob" });
          downloadBtn.textContent = `Download ZIP (${(zipBlob.size / 1024 / 1024).toFixed(2)} MB)`;
          
        } catch (err) {
          status.textContent = "ZIP Error: " + err.message;
          status.className = "status error";
        }
        
        runBtn.disabled = false;
        forceBtn.disabled = false;
      }

      else if (msg.type === 'error') {
        runBtn.disabled = false;
        forceBtn.disabled = false;
        status.textContent = "Error: " + msg.message;
        status.className = "status error";
      }
    };
  </script>
</body>
</html>