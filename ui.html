<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; color: #333; }
    
    /* TABS */
    .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
    .tab { padding: 10px 15px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 2px solid transparent; }
    .tab.active { color: #18A0FB; border-bottom: 2px solid #18A0FB; }
    .tab:hover:not(.active) { color: #333; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* LAYOUT */
    .row { display: flex; gap: 15px; margin-bottom: 15px; }
    .col { flex: 1; }
    .settings-container { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 15px; }
    
    /* INPUTS */
    label { font-weight: bold; font-size: 12px; cursor: pointer; display: block; margin-bottom: 5px; }
    select, button, input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    
    /* Inline Controls */
    .input-line { display: flex; align-items: center; height: 30px; }
    .checkbox-group { display: flex; align-items: center; height: 30px; }
    
    .input-inline {
      width: 40px; padding: 4px; text-align: center; border-radius: 4px; border: 1px solid #ccc;
      margin-left: 8px; font-size: 12px; height: 28px; box-sizing: border-box;
    }
    
    .helper-text { font-size: 10px; color: #999; margin-top: 2px; line-height: 1.2; }
    
    .checkbox-label { display: flex; align-items: center; font-weight: normal; margin: 0; white-space: nowrap; }
    input[type="checkbox"] { width: auto; margin: 0 6px 0 0; }

    /* BUTTONS */
    .btn-primary { background: #18A0FB; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary:hover { background: #0D8ADB; }
    .btn-secondary { background: white; color: #333; cursor: pointer; font-weight: normal; border: 1px solid #ccc; }
    .btn-secondary:hover { background: #f0f0f0; }
    .btn-success { background: #22c55e; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-success:hover { background: #16a34a; }
    .btn-neutral { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; cursor: pointer; font-weight: bold; }
    .btn-neutral:hover { background: #e5e7eb; }
    
    button:disabled, select:disabled, input:disabled { background: #eee !important; color: #aaa !important; cursor: not-allowed; border-color: #ddd; }

    /* TEXTAREA */
    textarea { width: 100%; height: 175px; font-family: monospace; font-size: 11px; margin-top: 5px; border: 1px solid #ddd; }
    
    /* STATUS & META */
    .status { margin-top: 10px; font-size: 12px; font-weight: bold; }
    .status.error { color: red; }
    .status.success { color: green; }
    .meta-info { font-size: 11px; color: #666; margin-top: 15px; background: #f5f5f5; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('tab-export')">JSON Exporter</div>
    <div class="tab" onclick="switchTab('tab-extract')">Frame Extractor</div>
  </div>

  <div id="tab-export" class="tab-content active">
    <h3>TCG Arena Card Exporter</h3>

    <div style="margin-bottom: 15px;">
      <label for="pageSelect">Select Page to Scan</label>
      <select id="pageSelect"></select>
    </div>

    <div class="settings-container">
      <div class="depth-group">
        <div class="input-line">
          <label for="scanDepth">Scan Depth</label>
          <input type="number" id="scanDepth" class="input-inline" value="3" min="1" max="10">
        </div>
        <div class="helper-text">increase this if cards<br>are nested too deeply</div>
      </div>
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="chkExportImages" checked>
          Export Images (PNG)
        </label>
      </div>
    </div>

    <div class="row">
      <button id="runBtn" class="btn-primary col">Smart Scan</button>
      <button id="forceBtn" class="btn-secondary col">Force Full Scan</button>
    </div>

    <div id="status" class="status">Ready.</div>
    
    <div id="lastScanInfo" class="meta-info hidden">
      <strong>Last Scan:</strong> <span id="lastScanTime">Never</span> | <span id="lastScanCount">0</span> items.
    </div>

    <div id="resultArea" class="hidden">
      <label style="margin-top:10px;">JSON Output</label>
      <textarea id="output" readonly></textarea>
      <div class="row" style="margin-top: 10px;">
        <button id="downloadBtn" class="btn-success col">Download ZIP</button>
        <button id="copyBtn" class="btn-neutral col">Copy JSON</button>
      </div>
    </div>
  </div>

  <div id="tab-extract" class="tab-content">
    <h3>Card Frame Extractor</h3>
    <p class="helper-text" style="font-size:12px; margin-bottom:15px; color:#555;">
      Scans the Source Page for cards (including "card-?"), indexes them, and copies the frames to the Target Page.
    </p>

    <div style="margin-bottom: 15px;">
      <label for="sourcePageSelect">Source Page (Scan Here)</label>
      <select id="sourcePageSelect"></select>
    </div>

    <div style="margin-bottom: 20px;">
      <label for="targetPageSelect">Target Page (Copy To)</label>
      <select id="targetPageSelect"></select>
      <div class="helper-text" style="color:red; margin-top:5px;">Warning: Target Page content will be cleared!</div>
    </div>

    <button id="extractBtn" class="btn-primary">Extract Frames</button>
    <div id="extractStatus" class="status">Ready.</div>
  </div>

  <script>
    // --- Elements: Tab 1 ---
    const pageSelect = document.getElementById('pageSelect');
    const scanDepthInput = document.getElementById('scanDepth');
    const chkExportImages = document.getElementById('chkExportImages');
    const runBtn = document.getElementById('runBtn');
    const forceBtn = document.getElementById('forceBtn');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    const resultArea = document.getElementById('resultArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const lastScanInfo = document.getElementById('lastScanInfo');
    const lastScanTime = document.getElementById('lastScanTime');
    const lastScanCount = document.getElementById('lastScanCount');

    // --- Elements: Tab 2 ---
    const sourcePageSelect = document.getElementById('sourcePageSelect');
    const targetPageSelect = document.getElementById('targetPageSelect');
    const extractBtn = document.getElementById('extractBtn');
    const extractStatus = document.getElementById('extractStatus');

    let zipBlob = null;
    let accumulatedImages = [];

    // --- TABS ---
    window.switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      
      document.getElementById(tabId).classList.add('active');
      const activeTabBtn = document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`);
      if(activeTabBtn) activeTabBtn.classList.add('active');
    };

    // --- UI HELPERS ---
    function toggleInputs(disabled) {
      // Disable everything that can be clicked or typed in
      const allInputs = document.querySelectorAll('button, select, input');
      allInputs.forEach(el => el.disabled = disabled);
    }

    // --- EXPORT FUNCTION ---
    function startScan(forceFull) {
      const pageId = pageSelect.value;
      const doImages = chkExportImages.checked;
      const depth = parseInt(scanDepthInput.value, 10) || 3;
      
      if (!pageId) return;

      accumulatedImages = [];
      zipBlob = null;
      
      toggleInputs(true);
      
      const modeText = forceFull ? "Full Scan" : "Smart Scan";
      status.textContent = `Running ${modeText}...`;
      status.className = "status";
      resultArea.classList.add('hidden');
      lastScanInfo.classList.add('hidden'); 

      parent.postMessage({ pluginMessage: { 
        type: 'run-scan', 
        pageId: pageId,
        exportImages: doImages,
        forceFull: forceFull,
        scanDepth: depth 
      }}, '*');
    }

    // --- EXTRACT FUNCTION ---
    extractBtn.onclick = () => {
      const sourceId = sourcePageSelect.value;
      const targetId = targetPageSelect.value;

      if (!sourceId || !targetId) return;
      if (sourceId === targetId) {
        alert("Source and Target pages must be different.");
        return;
      }

      toggleInputs(true);
      extractStatus.textContent = "Extracting frames...";
      extractStatus.className = "status";

      parent.postMessage({ pluginMessage: { 
        type: 'run-extract', 
        sourceId: sourceId,
        targetId: targetId
      }}, '*');
    };

    // --- EVENT LISTENERS TAB 1 ---
    runBtn.onclick = () => startScan(false);
    forceBtn.onclick = () => startScan(true);

    copyBtn.onclick = () => {
      output.select();
      document.execCommand('copy'); 
      const originalText = copyBtn.textContent;
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = originalText, 1500);
    };

    downloadBtn.onclick = () => {
      if (zipBlob) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `cards_export_${dateStr}_${timeStr}.zip`;
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = filename;
        link.click();
      }
    };

    // --- MESSAGE HANDLER ---
    window.onmessage = async (event) => {
      if (!event.data || !event.data.pluginMessage) return;
      const msg = event.data.pluginMessage;

      // 1. INIT
      if (msg.type === 'init-state') {
        // Fill all dropdowns
        const fillSelect = (sel) => {
          sel.innerHTML = "";
          msg.pages.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            if (p.current) opt.selected = true;
            sel.appendChild(opt);
          });
        };

        fillSelect(pageSelect);
        fillSelect(sourcePageSelect);
        fillSelect(targetPageSelect);

        // Load Cache
        if (msg.lastScanDate) {
          lastScanInfo.classList.remove('hidden');
          lastScanTime.textContent = new Date(msg.lastScanDate).toLocaleString();
          lastScanCount.textContent = msg.lastScanCount || 0;
          if (msg.lastJson) {
            output.value = msg.lastJson;
            resultArea.classList.remove('hidden');
          }
        }
        
        status.textContent = "Ready.";
        toggleInputs(false);
      }

      // 2. EXPORT PROGRESS
      else if (msg.type === 'image-chunk') {
        if (msg.data) accumulatedImages.push({ filename: msg.filename, data: msg.data });
        status.textContent = `Processing... (${msg.current} / ${msg.total})`;
      }

      // 3. EXPORT COMPLETE
      else if (msg.type === 'complete') {
        status.textContent = `Generating ZIP...`;
        output.value = msg.json;
        resultArea.classList.remove('hidden');
        lastScanInfo.classList.remove('hidden');
        lastScanTime.textContent = "Just now";
        lastScanCount.textContent = msg.count;

        try {
          const zip = new JSZip();
          zip.file("cards.json", msg.json);
          if (accumulatedImages.length > 0) {
            const imgFolder = zip.folder("img");
            accumulatedImages.forEach(img => imgFolder.file(img.filename, img.data));
          }
          zipBlob = await zip.generateAsync({ type: "blob" });
          downloadBtn.textContent = `Download ZIP (${(zipBlob.size / 1024 / 1024).toFixed(2)} MB)`;
          status.textContent = `Done! Processed ${msg.count} items.`;
          status.className = "status success";
        } catch (err) {
          status.textContent = "ZIP Error: " + err.message;
          status.className = "status error";
        }
        toggleInputs(false);
      }

      // 4. EXTRACT COMPLETE
      else if (msg.type === 'extract-complete') {
        extractStatus.textContent = `Success! Copied ${msg.count} frames to "${msg.targetName}".`;
        extractStatus.className = "status success";
        toggleInputs(false);
      }

      // 5. ERROR
      else if (msg.type === 'error') {
        toggleInputs(false);
        const activeStatus = document.querySelector('.tab-content.active .status');
        if (activeStatus) {
            activeStatus.textContent = "Error: " + msg.message;
            activeStatus.className = "status error";
        } else {
            alert("Error: " + msg.message);
        }
      }
    };
  </script>
</body>
</html>